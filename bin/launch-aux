#!/usr/bin/env bash

type=c3.8xlarge
label=aux
nrhosts=1
monitoring=
secgroup=default
placementgroup=cluster
price=1.0
zone=
ami=
on_demand=
keypair=`whoami`

while [ $# -gt 0 ] ; do
  case "$1" in
    -t | --type)           type="$2"; shift;;
    -h | --hosts)          nrhosts="$2"; shift;;
    -m | --monitoring)     monitoring=1;;
    -p | --price)          price="$2"; shift;;
    -s | --secgroup)       secgroup="$2"; shift;;
    -g | --placementgroup) placementgroup="$2"; shift;;
    -z | --zone)           zone="$2"; shift;;
    -o | --on-demand)      on_demand=y ;;
    -k | --keypair)        keypair="$2"; shift;;
    --ami)                 ami="$2"; shift;;
    --)                    shift; break;;
    -*)                    shift;;
    *)                     break;;
  esac
  shift
done

if [ $# -gt 0 ] ; then
  MASTER_HOST=$1
  shift
else
  echo "usage: launch-aux <master> <count>" && exit 1
fi

if [ $# -gt 0 ] ; then
  nrhosts=$1
  shift
else
  echo "usage: launch-aux <master> <count>" && exit 1
fi

bin=`dirname "$0"`
bin=`cd "$bin"; pwd`
export bin
if [ -f "$bin"/credentials.sh ] ; then
  source "$bin"/credentials.sh
fi
source "$bin"/env.sh

echo "TYPE: $type"
echo "MASTER_HOST: $MASTER_HOST"

if [ ! -z $ami ] ; then
  AMI=$ami
fi

echo "AMI: $AMI"

[ -z $AMI ] && echo "No AMI found" && exit 1

rm -f /tmp/userdata$$
echo "#!/bin/bash" >> /tmp/userdata$$
echo "JAVA_URL=$JAVA_URL" >> /tmp/userdata$$
echo "HADOOP_URL=$HADOOP_URL" >> /tmp/userdata$$
echo "HBASE_URL=$HBASE_URL" >> /tmp/userdata$$
echo "MASTER_HOST=$MASTER_HOST" >> /tmp/userdata$$
cat "$bin"/image/tarball/setup-slave-remote.pre >> /tmp/userdata$$
cat "$bin"/image/tarball/setup-remote >> /tmp/userdata$$
cat "$bin"/image/tarball/setup-aux-remote.post >> /tmp/userdata$$
gzip -9 /tmp/userdata$$

if [ ! -z "$on_demand" ] ; then
  CMD="ec2-run-instances $AMI $TOOL_OPTS -n $nrhosts -k $keypair -t $type -g $secgroup --placement-group $placementgroup -f /tmp/userdata$$.gz"
else
  CMD="ec2-request-spot-instances $AMI $TOOL_OPTS -n $nrhosts -k $keypair -t $type -g $secgroup --placement-group $placementgroup -p $price -f /tmp/userdata$$.gz"
fi
# need to specify ephemeral drive mappings or they won't appear
CMD="$CMD -b /dev/sdb=ephemeral0 -b /dev/sdc=ephemeral1 -b /dev/sdd=ephemeral2 -b /dev/sde=ephemeral3"
if [ ! -z "$monitoring" ] ; then
  CMD="$CMD -m"
fi
if [ ! -z "$zone" ] ; then
  CMD="$CMD -z $zone"
fi
OUTPUT=`$CMD`
echo $OUTPUT

rm -f /tmp/userdata$$.gz
